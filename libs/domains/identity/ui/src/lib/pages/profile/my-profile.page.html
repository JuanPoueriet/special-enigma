<div class="profile-page">
  <!-- Profile Header & Avatar -->
  <div class="profile-card">
    <div class="profile-header">
      <div class="profile-header__avatar-container">
        <div class="profile-header__avatar">
          <img [src]="avatarPreview() || 'assets/images/default-avatar.svg'"
               alt="Profile Avatar">
        </div>
        <label class="profile-header__upload-btn" title="{{ 'SETTINGS.PROFILE.CHANGE_AVATAR' | translate }}">
          <lucide-icon [img]="ImageIcon" class="w-5 h-5"></lucide-icon>
          <input type="file" class="hidden" (change)="onFileSelected($event)" accept="image/*">
        </label>
      </div>

      <div class="profile-header__info">
        <h1>
          {{ currentUser()?.firstName }} {{ currentUser()?.lastName }}
        </h1>
        <p>{{ currentUser()?.email }}</p>
        <div class="mt-2">
          <span class="profile-header__role-badge">
            {{ currentUser()?.roles?.[0]?.name || 'User' }}
          </span>
        </div>
      </div>
    </div>
  </div>

  <div class="settings-grid">
    <!-- Personal Information -->
    <div class="profile-card">
      <div class="profile-card__header">
        <lucide-icon [img]="UserIcon" class="w-5 h-5 text-primary-500"></lucide-icon>
        <h2>
          {{ 'SETTINGS.PROFILE.PERSONAL_INFO' | translate }}
        </h2>
      </div>

      <form [formGroup]="profileForm" (ngSubmit)="saveProfile()" class="space-y-4">
        <div class="form-grid">
          <div class="form-group">
            <label>{{ 'SETTINGS.PROFILE.FIRST_NAME' | translate }}</label>
            <div class="form-group__input-wrapper">
               <input type="text" formControlName="firstName" placeholder="John">
            </div>
          </div>
          <div class="form-group">
            <label>{{ 'SETTINGS.PROFILE.LAST_NAME' | translate }}</label>
            <div class="form-group__input-wrapper">
               <input type="text" formControlName="lastName" placeholder="Doe">
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>{{ 'SETTINGS.PROFILE.EMAIL' | translate }}</label>
          <div class="form-group__input-wrapper">
            <span class="form-group__icon">
              <lucide-icon [img]="MailIcon" class="w-5 h-5"></lucide-icon>
            </span>
            <input type="email" formControlName="email" class="has-icon" readonly>
          </div>
        </div>

        <div class="form-group">
          <label>{{ 'SETTINGS.PROFILE.PHONE' | translate }}</label>
          <div class="flex gap-3">
            <div class="form-group__input-wrapper flex-1">
              <span class="form-group__icon">
                <lucide-icon [img]="PhoneIcon" class="w-5 h-5"></lucide-icon>
              </span>
              <input type="tel" formControlName="phone" class="has-icon" placeholder="+1 (555) 000-0000">
            </div>
            <button type="button"
                    (click)="openPhoneVerification()"
                    class="btn btn--verify">
              {{ 'SETTINGS.PROFILE.VERIFY' | translate }}
            </button>
          </div>
        </div>

        <div class="form-group">
          <label>{{ 'SETTINGS.PROFILE.JOB_TITLE' | translate }}</label>
          <div class="form-group__input-wrapper">
             <span class="form-group__icon">
                <lucide-icon [img]="CompanyIcon" class="w-5 h-5"></lucide-icon>
             </span>
             <select formControlName="jobTitle" class="has-icon">
                 <option value="" disabled>{{ 'SETTINGS.PROFILE.SELECT_JOB_TITLE' | translate }}</option>
                 <option *ngFor="let title of jobTitles()" [value]="title">{{ title }}</option>
             </select>
          </div>
        </div>

        <div class="pt-6 flex justify-end">
          <button type="submit"
                  [disabled]="profileForm.invalid || profileForm.pristine || isLoading"
                  class="btn btn--primary">
            @if (isLoading) {
              <span class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></span>
            } @else {
              <lucide-icon [img]="SaveIcon" class="w-4 h-4"></lucide-icon>
            }
            {{ 'SETTINGS.PROFILE.SAVE_CHANGES' | translate }}
          </button>
        </div>
      </form>
    </div>

    <!-- Security Settings (Password & 2FA) -->
    <div class="space-y-8">
       <!-- Password Change -->
       <div class="profile-card">
          <div class="profile-card__header">
            <lucide-icon [img]="ShieldIcon" class="w-5 h-5 text-primary-500"></lucide-icon>
            <h2>
              {{ 'SETTINGS.PROFILE.SECURITY' | translate }}
            </h2>
          </div>

          <form [formGroup]="passwordForm" (ngSubmit)="changePassword()" class="space-y-4">
             <!-- Hidden username for accessibility -->
             <input type="text" autocomplete="username" class="hidden" value="{{currentUser()?.email}}">

             <div class="form-group">
                <label>{{ 'SETTINGS.PROFILE.CURRENT_PASSWORD' | translate }}</label>
                <div class="form-group__input-wrapper">
                    <input type="password" formControlName="currentPassword" autocomplete="current-password" placeholder="••••••••">
                </div>
             </div>

             <div class="form-group">
                <label>{{ 'SETTINGS.PROFILE.NEW_PASSWORD' | translate }}</label>
                <div class="form-group__input-wrapper">
                    <input type="password" formControlName="newPassword" autocomplete="new-password" placeholder="••••••••">
                </div>
             </div>

             <div class="form-group">
                <label>{{ 'SETTINGS.PROFILE.CONFIRM_PASSWORD' | translate }}</label>
                <div class="form-group__input-wrapper">
                    <input type="password" formControlName="confirmPassword" autocomplete="new-password" placeholder="••••••••">
                </div>
             </div>

             <div class="pt-4 flex justify-end">
                <button type="submit"
                        [disabled]="passwordForm.invalid"
                        class="btn btn--secondary">
                   {{ 'SETTINGS.PROFILE.UPDATE_PASSWORD' | translate }}
                </button>
             </div>
          </form>
       </div>

       <!-- 2FA & Sessions -->
       <app-security-settings></app-security-settings>
    </div>
  </div>
</div>

<!-- Phone Verification Modal -->
<app-phone-verification-modal
   [isOpen]="showPhoneModal"
   (close)="showPhoneModal.set(false)"
   (verified)="onPhoneVerified()">
</app-phone-verification-modal>
